# chef-3scale-cookbook

TODO: Enter the cookbook description here.

## Supported Platforms

TODO: List your supported platforms.

## Attributes

There are 4 attributes that you will need to set to configure how you use the cookbook. All of them are under the `chef-3scale` namespace:

<table>
  <tr>
    <th>Key</th>
    <th>Type</th>
    <th>Description</th>
    <th>Default</th>
  </tr>
  <tr>
    <td><tt>['3scale']['config-source']</tt></td>
    <td>String</td>
    <td>Where your Nginx configuration files will be taken from. Two options: “local” or “3scale”. More on this the section “Applying your own 3scale configuration”.</td>
    <td><tt>'local'</tt></td>
  </tr>
  <tr>
    <td><tt>['3scale']['provider-key']</tt></td>
    <td>String</td>
    <td>The key that identifies you as a 3scale customer. It can be found in the “Account” menu of your 3scale admin portal.</td>
    <td><tt>'REPLACE_WITH_3SCALE_PROVIDER_KEY'</tt></td>
  </tr>
  <tr>
    <td><tt>['3scale']['admin-domain']</tt></td>
    <td>String</td>
    <td>If your 3scale admin portal domain is “mycompany-admin.3scale.net”, then the value of this attribute should be “mycompany”.</td>
    <td><tt>'REPLACE_WITH_3SCALE_ADMIN_URL_PART'</tt></td>
  </tr>
  <tr>
    <td><tt>['3scale']['config-version']</tt></td>
    <td>String</td>
    <td>Version id. If not included, the current configuration from your 3scale account will be used.  If included, the value must be a timestamp of one deployment, formatted like in the following example: “2015-09-15-041532”. See the “Rollback process” section for more information on this. </td>
    <td><tt>nil</tt></td>
  </tr>
</table>
 
The default value for each of those attributes is defined here: https://github.com/3scale/chef-3scale/tree/master/attributes


This cookbook uses and depends on the Openresty cookbook (https://github.com/priestjim/chef-openresty). Therefore attributes of that cookbook are also available to you. You can see a full list here: https://github.com/priestjim/chef-openresty#attributes 
Since you will be using the Nginx configuration files that 3scale generates for you, you will not be able to use the attributes of the Openresty cookbook that are related to configuration parameters that go in the nginx.conf file.

## Usage

### chef-3scale::default

Include `chef-3scale` in your node's `run_list`:

```json
{
  "run_list": [
    "recipe[chef-3scale::default]"
  ]
}
```

### Applying your own 3scale configuration

For the API gateway to be configured for your own API endpoints, you need to deploy it using your own set of Nginx configuration files. 

There are two ways to apply your own configuration files to the cookbook:

#### Option 1: Local configuration files 

configure your API in 3scale using the “On-premise Gateway” option
click on “Download the Nginx Config files” at the bottom of the screen
drop those files on the  `/files/default/config/` directory of the cookbook 

To use this option you will need to set the `['3scale']['config-source']` attribute to `“local”` in your node or role description.

####  Option 2: Fetch configuration files from your 3scale account

With this option the cookbook will automatically fetch the Nginx configuration files from your 3scale account when running the deployment.

To use this option you will need to set the following attributes in your node or role description:
- ['3scale']['config-source'] = “3scale”   
- ['3scale']['provider-key']  = (see attributes section)  
- ['3scale']['admin-domain']  = (see attributes section)  

In both cases, the Nginx configuration files will be copied to a subdirectory in the `/var/chef/cache/` and symlinked to the Nginx working directory (`/etc/nginx/`).

### Rollback process

The chef-3scale cookbook allows rolling back to a previously deployed version of the configuration. This is useful if you have a node where the API gateway had already been deployed one or multiple times, and you want to deploy it again but using the configuration files from one of the previous deployments instead of using the latest version.

The built-in way to roll back is by using the `['3scale']['config-version']` attribute. Here is an example of a full node description using the rollback attribute:


```json
{
  "3scale": {
    "provider-key": "YOURPROVIDERKEY",
    "admin-domain": "mycompany",
    "config-version": "2015-09-15-050545"
  },
  "openresty": {
    "source": {
      "prefix": "/etc"
    }
  },
  "run_list": [
    "recipe[chef-3scale::default]"
  ]
}
```

The value of the attribute must be the timestamp generated by the cookbook when running a deployment. This attribute is always logged and printed to the screen while running the cookbook:

```
 3SCALE - deploying gateway with LATEST configuration version: 2015-09-15-050545
````

When a gateway has been deployed using one of the previous versions of the configuration, the logged message will be slightly different:

```
 3SCALE - rolling back to configuration version: 2015-09-15-050545
```

The rollback process will symlink the configuration files located at:

```
  /var/chef/cache/<config-version-attribute>/*
```

to the Nginx configuration directory and then reload the gateway.

## License and Authors

Author:: Victor Delgado (<victor@3scale.net>)
